"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[100],{7100:(t,e,s)=>{s.d(e,{SiteProvider:()=>f,i:()=>m});var a=s(5155),r=s(2115);class o{static parse(t){let e={common:{},devices:[],stcpConfigs:[],otherSections:[]},s=t.split("\n").map(t=>t.trim()),a=null,r={},o=!1;for(let t=0;t<s.length;t++){let i=s[t];if(i){if("# DEVICE_REGISTRY_START"===i){o=!0;continue}if("# DEVICE_REGISTRY_END"===i){o=!1;continue}if(o&&i.startsWith("# ")&&i.includes("|")){let t=i.substring(2),s=this.parseDeviceEntry(t);s&&e.devices.push(s);continue}if(!i.startsWith("#")){if(i.startsWith("[")&&i.endsWith("]")){a&&Object.keys(r).length>0&&this.saveSection(a,r,e),a=i.slice(1,-1),r={};continue}if(i.includes("=")&&a){let[t,e]=i.split("=",2);r[t.trim()]=e.trim()}}}}return a&&Object.keys(r).length>0&&this.saveSection(a,r,e),e}static generate(t){let e="";if(Object.keys(t.common).length>0){for(let[s,a]of(e+="[common]\n",Object.entries(t.common)))e+="".concat(s," = ").concat(a,"\n");e+="\n"}if(t.devices.length>0){for(let s of(e+="# DEVICE_REGISTRY_START\n",t.devices))e+=this.generateDeviceEntry(s);e+="# DEVICE_REGISTRY_END\n\n"}for(let s of t.stcpConfigs)e+="[".concat(s.name,"]\n"),e+="type = ".concat(s.type,"\n"),e+="role = ".concat(s.role,"\n"),e+="sk = ".concat(s.sk,"\n"),e+="server_name = ".concat(s.server_name,"\n"),e+="bind_addr = ".concat(s.bind_addr,"\n"),e+="bind_port = ".concat(s.bind_port,"\n\n");for(let s of t.otherSections){for(let[t,a]of(e+="[".concat(s.name,"]\n"),Object.entries(s.config)))e+="".concat(t," = ").concat(a,"\n");e+="\n"}return e}static groupConfigsBySite(t,e){let s=new Map;for(let a of t){let t=a.sk;if(!s.has(t)){let a=e.find(e=>e.macAddress===t);s.set(t,{macAddress:t,siteCode:(null==a?void 0:a.siteId)||"",siteName:(null==a?void 0:a.siteName)||"",password:(null==a?void 0:a.password)||"",tags:(null==a?void 0:a.tags)||[],configs:[]})}s.get(t).configs.push(a)}return Array.from(s.values())}static parseDeviceEntry(t){let e=t.split("|").map(t=>t.trim());return e.length<4?null:{macAddress:e[0],siteId:e[1],siteName:e[2],password:e[3],tags:e[4]?e[4].split(",").map(t=>t.trim()):[]}}static generateDeviceEntry(t){let e=t.tags.length>0?t.tags.join(","):"";return"# ".concat(t.macAddress,"|").concat(t.siteId,"|").concat(t.siteName,"|").concat(t.password,"|").concat(e,"\n")}static saveSection(t,e,s){"common"===t?s.common={...e}:this.isSTCPSection(e)?s.stcpConfigs.push({name:t,type:e.type||"stcp",role:e.role||"visitor",sk:e.sk||"",server_name:e.server_name||"",bind_addr:e.bind_addr||"0.0.0.0",bind_port:parseInt(e.bind_port)||0}):s.otherSections.push({name:t,config:{...e}})}static isSTCPSection(t){return"stcp"===t.type&&"sk"in t&&"server_name"in t}}var i=s(9509);class c{static async detectAdminPort(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost";if(this.detectedPort)return this.detectedPort;for(let e of[7400,7401,7402,7500,8080,8081])try{let s=await fetch("http://".concat(t,":").concat(e,"/api/config"),{method:"HEAD",credentials:"include",headers:{Authorization:"Basic "+btoa("admin:admin")},signal:AbortSignal.timeout(2e3)});if(s.ok||401===s.status)return console.log("检测到 frpc admin 端口: ".concat(e)),this.detectedPort=e,e}catch(t){}return console.warn("未能自动检测到 frpc admin 端口，使用默认端口 7400"),this.detectedPort=7400,7400}getDefaultApiUrl(){if(i.env.NEXT_PUBLIC_FRPC_API_URL)return i.env.NEXT_PUBLIC_FRPC_API_URL;{let t=window.location.hostname;return"3001"===window.location.port?"http://".concat(t,":7400"):""}}async getConfigWithPortDetection(){if("3001"===window.location.port&&this.baseUrl.includes(":7400"))try{let t=window.location.hostname,e=await c.detectAdminPort(t);this.baseUrl="http://".concat(t,":").concat(e),console.log("已更新 API 地址为: ".concat(this.baseUrl))}catch(t){console.warn("端口检测失败，使用默认配置")}return this.getConfig()}async getConfig(){try{let t=await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",headers:{Accept:"text/plain",Authorization:"Basic "+btoa("admin:admin")}});if(!t.ok)throw Error("获取配置失败: ".concat(t.status," ").concat(t.statusText));return await t.text()}catch(t){throw console.error("Failed to get config:",t),Error("获取配置文件失败: ".concat(t instanceof Error?t.message:"未知错误"))}}async saveConfig(t){try{let e=await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",method:"PUT",headers:{"Content-Type":"text/plain",Authorization:"Basic "+btoa("admin:admin")},body:t});if(!e.ok)throw Error("保存配置失败: ".concat(e.status," ").concat(e.statusText))}catch(t){throw console.error("Failed to save config:",t),Error("保存配置文件失败: ".concat(t instanceof Error?t.message:"未知错误"))}}async reloadConfig(){try{let t=await fetch("".concat(this.baseUrl,"/api/reload"),{credentials:"include",method:"GET",headers:{Authorization:"Basic "+btoa("admin:admin")}});if(!t.ok)throw Error("重载配置失败: ".concat(t.status," ").concat(t.statusText))}catch(t){throw console.error("Failed to reload config:",t),Error("重新加载配置失败: ".concat(t instanceof Error?t.message:"未知错误"))}}async testConnection(){try{return(await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",method:"HEAD",headers:{Authorization:"Basic "+btoa("admin:admin")}})).ok}catch(t){return!1}}constructor(t){this.baseUrl=t||this.getDefaultApiUrl()}}c.detectedPort=null;class n{async loadData(){try{let t=await this.apiClient.getConfigWithPortDetection();return this.configData=o.parse(t),this.sites=this.convertToSites(this.configData),this.lastSyncTime=new Date,console.log("Loaded ".concat(this.sites.length," sites from config")),this.sites}catch(t){throw console.error("Failed to load sites:",t),t}}async saveData(){if(!this.configData)throw Error("No config data to save");try{this.updateConfigFromSites();let t=o.generate(this.configData);await this.apiClient.saveConfig(t),await this.apiClient.reloadConfig(),console.log("Sites saved successfully")}catch(t){throw console.error("Failed to save sites:",t),t}}getSites(){return[...this.sites]}searchSites(t){if(!t.trim())return this.sites;let e=t.toLowerCase();return this.sites.filter(t=>t.siteCode.toLowerCase().includes(e)||t.siteName.toLowerCase().includes(e)||t.macAddress.toLowerCase().includes(e)||t.tags.some(t=>t.toLowerCase().includes(e)))}filterSitesByTags(t){return 0===t.length?this.sites:this.sites.filter(e=>t.includes("无标签")?0===e.tags.length:t.some(t=>e.tags.includes(t)))}getAllTags(){let t=new Set;this.sites.forEach(e=>{e.tags.forEach(e=>t.add(e))});let e=Array.from(t).sort();return this.sites.some(t=>0===t.tags.length)&&e.push("无标签"),e}addSite(t){if(this.sites.some(e=>e.macAddress===t.macAddress))throw Error("MAC地址 ".concat(t.macAddress," 已存在"));if(this.sites.some(e=>e.siteCode===t.siteCode))throw Error("站点编号 ".concat(t.siteCode," 已存在"));this.sites.push(t)}updateSite(t,e){let s=this.sites.findIndex(e=>e.macAddress===t);if(-1===s)throw Error("找不到MAC地址为 ".concat(t," 的站点"));if(e.macAddress&&e.macAddress!==t&&this.sites.some(t=>t.macAddress===e.macAddress))throw Error("新MAC地址 ".concat(e.macAddress," 已存在"));if(e.siteCode&&e.siteCode!==this.sites[s].siteCode&&this.sites.some(t=>t.siteCode===e.siteCode))throw Error("新站点编号 ".concat(e.siteCode," 已存在"));this.sites[s]={...this.sites[s],...e}}deleteSite(t){let e=this.sites.findIndex(e=>e.macAddress===t);if(-1===e)throw Error("找不到MAC地址为 ".concat(t," 的站点"));this.sites.splice(e,1)}importSites(t){let e=[],s=0;for(let a of t)try{this.addSite(a),s++}catch(t){e.push("".concat(a.siteCode||a.macAddress,": ").concat(t instanceof Error?t.message:"未知错误"))}return{success:s,errors:e}}importSitesWithDuplicateCheck(t){let e=[],s=[],a=0;for(let r of t)try{this.sites.some(t=>t.macAddress===r.macAddress)?s.push(r):(this.addSite(r),a++)}catch(t){e.push("".concat(r.siteCode||r.macAddress,": ").concat(t instanceof Error?t.message:"未知错误"))}return{success:a,errors:e,duplicates:s}}importSitesWithOverwrite(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=[],a=0,r=0;for(let o of t)try{let t=this.sites.findIndex(t=>t.macAddress===o.macAddress);if(-1!==t){if(e){let e={...this.sites[t]};Object.keys(o).forEach(t=>{let s=o[t];""!==s&&null!=s&&("tags"===t&&Array.isArray(s)&&s.length>0?e[t]=s:"tags"!==t&&s&&(e[t]=s))}),this.sites[t]=e,r++}else s.push("".concat(o.siteCode||o.macAddress,": MAC地址已存在"))}else this.addSite(o),a++}catch(t){s.push("".concat(o.siteCode||o.macAddress,": ").concat(t instanceof Error?t.message:"未知错误"))}return{success:a,errors:s,overwritten:r}}allocateBindPort(){let t=new Set;this.sites.forEach(e=>{e.configs.forEach(e=>{t.add(e.bind_port)})});let e=18e3;for(;t.has(e);)e++;return e}generateDefaultConfigs(t){let e=[];for(let s of[22,3306,5e3])e.push({name:"R-".concat(t.macAddress,"-").concat(s),type:"stcp",role:"visitor",server_name:"R-".concat(t.macAddress,"-").concat(s),sk:t.macAddress,bind_addr:"0.0.0.0",bind_port:this.allocateBindPort()});return e}getLastSyncTime(){return this.lastSyncTime}convertToSites(t){return o.groupConfigsBySite(t.stcpConfigs,t.devices)}updateConfigFromSites(){this.configData&&(this.configData.devices=this.sites.map(t=>({macAddress:t.macAddress,siteId:t.siteCode,siteName:t.siteName,password:t.password,tags:t.tags})),this.configData.stcpConfigs=[],this.sites.forEach(t=>{t.configs.forEach(t=>{this.configData.stcpConfigs.push({name:t.name,type:t.type,role:t.role,sk:t.sk,server_name:t.server_name,bind_addr:t.bind_addr,bind_port:t.bind_port})})}))}constructor(t){this.configData=null,this.sites=[],this.lastSyncTime=null,this.apiClient=t||new c}}var d=s(6671);let l={sites:[],filteredSites:[],loading:!1,error:null,editMode:!1,searchTerm:"",selectedTags:[],allTags:[],lastSyncTime:null};function h(t,e){switch(e.type){case"SET_LOADING":return{...t,loading:e.payload};case"SET_ERROR":return{...t,error:e.payload};case"SET_SITES":return{...t,sites:e.payload};case"SET_EDIT_MODE":return{...t,editMode:e.payload};case"SET_SEARCH_TERM":return{...t,searchTerm:e.payload};case"SET_SELECTED_TAGS":return{...t,selectedTags:e.payload};case"UPDATE_FILTERED_SITES":return{...t,filteredSites:e.payload};case"SET_ALL_TAGS":return{...t,allTags:e.payload};case"SET_LAST_SYNC_TIME":return{...t,lastSyncTime:e.payload};case"ADD_SITE":return{...t,sites:[...t.sites,e.payload]};case"UPDATE_SITE":{let s=t.sites.map(t=>t.macAddress===e.payload.macAddress?{...t,...e.payload.updates}:t);return{...t,sites:s}}case"DELETE_SITE":{let s=t.sites.filter(t=>t.macAddress!==e.payload);return{...t,sites:s}}default:return t}}let p=(0,r.createContext)(void 0),u=new n(new c);function f(t){let{children:e}=t,[s,o]=(0,r.useReducer)(h,l),i=(t,e,s)=>{let a=t;if(e.trim()){let t=e.toLowerCase();a=a.filter(e=>e.siteCode.toLowerCase().includes(t)||e.siteName.toLowerCase().includes(t)||e.macAddress.toLowerCase().includes(t)||e.tags.some(e=>e.toLowerCase().includes(t)))}s.length>0&&(a=a.filter(t=>s.includes("无标签")?0===t.tags.length:s.some(e=>t.tags.includes(e)))),o({type:"UPDATE_FILTERED_SITES",payload:a})};(0,r.useEffect)(()=>{i(s.sites,s.searchTerm,s.selectedTags)},[s.sites,s.searchTerm,s.selectedTags]),(0,r.useEffect)(()=>{o({type:"SET_ALL_TAGS",payload:u.getAllTags()})},[s.sites]);let c={async loadSites(){o({type:"SET_LOADING",payload:!0}),o({type:"SET_ERROR",payload:null});try{let t=await u.loadData();o({type:"SET_SITES",payload:t}),o({type:"SET_LAST_SYNC_TIME",payload:u.getLastSyncTime()}),d.oR.success("成功加载 ".concat(t.length," 个站点"))}catch(e){let t=e instanceof Error?e.message:"加载站点失败";o({type:"SET_ERROR",payload:t}),d.oR.error(t)}finally{o({type:"SET_LOADING",payload:!1})}},async saveSites(){o({type:"SET_LOADING",payload:!0}),o({type:"SET_ERROR",payload:null});try{await u.saveData(),o({type:"SET_LAST_SYNC_TIME",payload:new Date}),d.oR.success("配置保存成功")}catch(e){let t=e instanceof Error?e.message:"保存配置失败";throw o({type:"SET_ERROR",payload:t}),d.oR.error(t),e}finally{o({type:"SET_LOADING",payload:!1})}},setEditMode(t){o({type:"SET_EDIT_MODE",payload:t})},setSearchTerm(t){o({type:"SET_SEARCH_TERM",payload:t})},setSelectedTags(t){o({type:"SET_SELECTED_TAGS",payload:t})},async addSite(t){try{u.addSite(t),o({type:"ADD_SITE",payload:t}),d.oR.success("站点 ".concat(t.siteCode," 添加成功"))}catch(e){let t=e instanceof Error?e.message:"添加站点失败";throw d.oR.error(t),e}},async updateSite(t,e){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{u.updateSite(t,e),o({type:"UPDATE_SITE",payload:{macAddress:t,updates:e}}),s||d.oR.success("站点更新成功")}catch(e){let t=e instanceof Error?e.message:"更新站点失败";throw d.oR.error(t),e}},async deleteSite(t){try{u.deleteSite(t),o({type:"DELETE_SITE",payload:t}),d.oR.success("站点删除成功")}catch(e){let t=e instanceof Error?e.message:"删除站点失败";throw d.oR.error(t),e}},async importSites(t){try{let e=u.importSites(t),s=u.getSites();return o({type:"SET_SITES",payload:s}),e.success>0&&(await u.saveData(),o({type:"SET_LAST_SYNC_TIME",payload:new Date}),d.oR.success("成功导入 ".concat(e.success," 个站点并已保存"))),e.errors.length>0&&d.oR.error("导入失败: ".concat(e.errors.slice(0,3).join("; ")).concat(e.errors.length>3?"...":"")),e}catch(e){let t=e instanceof Error?e.message:"导入失败";throw d.oR.error(t),e}},async importSitesWithDuplicateCheck(t){try{let e=u.importSitesWithDuplicateCheck(t),s=u.getSites();return o({type:"SET_SITES",payload:s}),e.success>0&&(await u.saveData(),o({type:"SET_LAST_SYNC_TIME",payload:new Date})),e}catch(e){let t=e instanceof Error?e.message:"检测重复失败";throw d.oR.error(t),e}},async importSitesWithOverwrite(t,e){try{let s=u.importSitesWithOverwrite(t,e),a=u.getSites();o({type:"SET_SITES",payload:a}),(s.success>0||s.overwritten>0)&&(await u.saveData(),o({type:"SET_LAST_SYNC_TIME",payload:new Date}));let r="";return s.success>0&&(r+="新增 ".concat(s.success," 个站点")),s.overwritten>0&&(r+="".concat(r?"，":"","覆盖 ").concat(s.overwritten," 个站点")),r&&d.oR.success("".concat(r,"并已保存")),s.errors.length>0&&d.oR.error("导入失败: ".concat(s.errors.slice(0,3).join("; ")).concat(s.errors.length>3?"...":"")),s}catch(e){let t=e instanceof Error?e.message:"导入失败";throw d.oR.error(t),e}},async refreshData(){await c.loadSites()}};return(0,a.jsx)(p.Provider,{value:{state:s,actions:c},children:e})}function m(){let t=(0,r.useContext)(p);if(void 0===t)throw Error("useSiteContext must be used within a SiteProvider");return t}}}]);