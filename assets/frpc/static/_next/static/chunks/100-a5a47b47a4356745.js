"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[100],{7100:(e,t,s)=>{s.d(t,{SiteProvider:()=>f,i:()=>u});var a=s(5155),r=s(2115);class o{static parse(e){let t={common:{},devices:[],stcpConfigs:[],otherSections:[]},s=e.split("\n").map(e=>e.trim()),a=null,r={},o=!1;for(let e=0;e<s.length;e++){let i=s[e];if(i){if("# DEVICE_REGISTRY_START"===i){o=!0;continue}if("# DEVICE_REGISTRY_END"===i){o=!1;continue}if(o&&i.startsWith("# ")&&i.includes("|")){let e=i.substring(2),s=this.parseDeviceEntry(e);s&&t.devices.push(s);continue}if(!i.startsWith("#")){if(i.startsWith("[")&&i.endsWith("]")){a&&Object.keys(r).length>0&&this.saveSection(a,r,t),a=i.slice(1,-1),r={};continue}if(i.includes("=")&&a){let[e,t]=i.split("=",2);r[e.trim()]=t.trim()}}}}return a&&Object.keys(r).length>0&&this.saveSection(a,r,t),t}static generate(e){let t="";if(Object.keys(e.common).length>0){for(let[s,a]of(t+="[common]\n",Object.entries(e.common)))t+="".concat(s," = ").concat(a,"\n");t+="\n"}if(e.devices.length>0){for(let s of(t+="# DEVICE_REGISTRY_START\n",e.devices))t+=this.generateDeviceEntry(s);t+="# DEVICE_REGISTRY_END\n\n"}for(let s of e.stcpConfigs)t+="[".concat(s.name,"]\n"),t+="type = ".concat(s.type,"\n"),t+="role = ".concat(s.role,"\n"),t+="sk = ".concat(s.sk,"\n"),t+="server_name = ".concat(s.server_name,"\n"),t+="bind_addr = ".concat(s.bind_addr,"\n"),t+="bind_port = ".concat(s.bind_port,"\n\n");for(let s of e.otherSections){for(let[e,a]of(t+="[".concat(s.name,"]\n"),Object.entries(s.config)))t+="".concat(e," = ").concat(a,"\n");t+="\n"}return t}static groupConfigsBySite(e,t){let s=new Map;for(let a of e){let e=a.sk;if(!s.has(e)){let a=t.find(t=>t.macAddress===e);s.set(e,{macAddress:e,siteCode:(null==a?void 0:a.siteId)||"",siteName:(null==a?void 0:a.siteName)||"",password:(null==a?void 0:a.password)||"",tags:(null==a?void 0:a.tags)||[],configs:[]})}s.get(e).configs.push(a)}return Array.from(s.values())}static parseDeviceEntry(e){let t=e.split("|").map(e=>e.trim());return t.length<4?null:{macAddress:t[0],siteId:t[1],siteName:t[2],password:t[3],tags:t[4]?t[4].split(",").map(e=>e.trim()):[]}}static generateDeviceEntry(e){let t=e.tags.length>0?e.tags.join(","):"";return"# ".concat(e.macAddress,"|").concat(e.siteId,"|").concat(e.siteName,"|").concat(e.password,"|").concat(t,"\n")}static saveSection(e,t,s){"common"===e?s.common={...t}:this.isSTCPSection(t)?s.stcpConfigs.push({name:e,type:t.type||"stcp",role:t.role||"visitor",sk:t.sk||"",server_name:t.server_name||"",bind_addr:t.bind_addr||"0.0.0.0",bind_port:parseInt(t.bind_port)||0}):s.otherSections.push({name:e,config:{...t}})}static isSTCPSection(e){return"stcp"===e.type&&"sk"in e&&"server_name"in e}}class i{async getConfig(){try{let e=await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",headers:{Accept:"text/plain",Authorization:"Basic "+btoa("admin:admin")}});if(!e.ok)throw Error("获取配置失败: ".concat(e.status," ").concat(e.statusText));return await e.text()}catch(e){throw console.error("Failed to get config:",e),Error("获取配置文件失败: ".concat(e instanceof Error?e.message:"未知错误"))}}async saveConfig(e){try{let t=await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",method:"PUT",headers:{"Content-Type":"text/plain",Authorization:"Basic "+btoa("admin:admin")},body:e});if(!t.ok)throw Error("保存配置失败: ".concat(t.status," ").concat(t.statusText))}catch(e){throw console.error("Failed to save config:",e),Error("保存配置文件失败: ".concat(e instanceof Error?e.message:"未知错误"))}}async reloadConfig(){try{let e=await fetch("".concat(this.baseUrl,"/api/reload"),{credentials:"include",method:"GET",headers:{Authorization:"Basic "+btoa("admin:admin")}});if(!e.ok)throw Error("重载配置失败: ".concat(e.status," ").concat(e.statusText))}catch(e){throw console.error("Failed to reload config:",e),Error("重新加载配置失败: ".concat(e instanceof Error?e.message:"未知错误"))}}async testConnection(){try{return(await fetch("".concat(this.baseUrl,"/api/config"),{credentials:"include",method:"HEAD",headers:{Authorization:"Basic "+btoa("admin:admin")}})).ok}catch(e){return!1}}constructor(e=""){this.baseUrl=e}}class n{async loadData(){try{let e=await this.apiClient.getConfig();return this.configData=o.parse(e),this.sites=this.convertToSites(this.configData),this.lastSyncTime=new Date,console.log("Loaded ".concat(this.sites.length," sites from config")),this.sites}catch(e){throw console.error("Failed to load sites:",e),e}}async saveData(){if(!this.configData)throw Error("No config data to save");try{this.updateConfigFromSites();let e=o.generate(this.configData);await this.apiClient.saveConfig(e),await this.apiClient.reloadConfig(),console.log("Sites saved successfully")}catch(e){throw console.error("Failed to save sites:",e),e}}getSites(){return[...this.sites]}searchSites(e){if(!e.trim())return this.sites;let t=e.toLowerCase();return this.sites.filter(e=>e.siteCode.toLowerCase().includes(t)||e.siteName.toLowerCase().includes(t)||e.macAddress.toLowerCase().includes(t)||e.tags.some(e=>e.toLowerCase().includes(t)))}filterSitesByTags(e){return 0===e.length?this.sites:this.sites.filter(t=>e.includes("无标签")?0===t.tags.length:e.some(e=>t.tags.includes(e)))}getAllTags(){let e=new Set;this.sites.forEach(t=>{t.tags.forEach(t=>e.add(t))});let t=Array.from(e).sort();return this.sites.some(e=>0===e.tags.length)&&t.push("无标签"),t}addSite(e){if(this.sites.some(t=>t.macAddress===e.macAddress))throw Error("MAC地址 ".concat(e.macAddress," 已存在"));if(this.sites.some(t=>t.siteCode===e.siteCode))throw Error("站点编号 ".concat(e.siteCode," 已存在"));this.sites.push(e)}updateSite(e,t){let s=this.sites.findIndex(t=>t.macAddress===e);if(-1===s)throw Error("找不到MAC地址为 ".concat(e," 的站点"));if(t.macAddress&&t.macAddress!==e&&this.sites.some(e=>e.macAddress===t.macAddress))throw Error("新MAC地址 ".concat(t.macAddress," 已存在"));if(t.siteCode&&t.siteCode!==this.sites[s].siteCode&&this.sites.some(e=>e.siteCode===t.siteCode))throw Error("新站点编号 ".concat(t.siteCode," 已存在"));this.sites[s]={...this.sites[s],...t}}deleteSite(e){let t=this.sites.findIndex(t=>t.macAddress===e);if(-1===t)throw Error("找不到MAC地址为 ".concat(e," 的站点"));this.sites.splice(t,1)}importSites(e){let t=[],s=0;for(let a of e)try{this.addSite(a),s++}catch(e){t.push("".concat(a.siteCode,": ").concat(e instanceof Error?e.message:"未知错误"))}return{success:s,errors:t}}allocateBindPort(){let e=new Set;this.sites.forEach(t=>{t.configs.forEach(t=>{e.add(t.bind_port)})});let t=18e3;for(;e.has(t);)t++;return t}generateDefaultConfigs(e){let t=[];for(let s of[22,3306,5e3])t.push({name:"R-".concat(e.macAddress,"-").concat(s),type:"stcp",role:"visitor",server_name:"R-".concat(e.macAddress,"-").concat(s),sk:e.macAddress,bind_addr:"0.0.0.0",bind_port:this.allocateBindPort()});return t}getLastSyncTime(){return this.lastSyncTime}convertToSites(e){return o.groupConfigsBySite(e.stcpConfigs,e.devices)}updateConfigFromSites(){this.configData&&(this.configData.devices=this.sites.map(e=>({macAddress:e.macAddress,siteId:e.siteCode,siteName:e.siteName,password:e.password,tags:e.tags})),this.configData.stcpConfigs=[],this.sites.forEach(e=>{e.configs.forEach(e=>{this.configData.stcpConfigs.push({name:e.name,type:e.type,role:e.role,sk:e.sk,server_name:e.server_name,bind_addr:e.bind_addr,bind_port:e.bind_port})})}))}constructor(e){this.configData=null,this.sites=[],this.lastSyncTime=null,this.apiClient=e||new i}}var c=s(6671);let d={sites:[],filteredSites:[],loading:!1,error:null,editMode:!1,searchTerm:"",selectedTags:[],allTags:[],lastSyncTime:null};function l(e,t){switch(t.type){case"SET_LOADING":return{...e,loading:t.payload};case"SET_ERROR":return{...e,error:t.payload};case"SET_SITES":return{...e,sites:t.payload};case"SET_EDIT_MODE":return{...e,editMode:t.payload};case"SET_SEARCH_TERM":return{...e,searchTerm:t.payload};case"SET_SELECTED_TAGS":return{...e,selectedTags:t.payload};case"UPDATE_FILTERED_SITES":return{...e,filteredSites:t.payload};case"SET_ALL_TAGS":return{...e,allTags:t.payload};case"SET_LAST_SYNC_TIME":return{...e,lastSyncTime:t.payload};case"ADD_SITE":return{...e,sites:[...e.sites,t.payload]};case"UPDATE_SITE":{let s=e.sites.map(e=>e.macAddress===t.payload.macAddress?{...e,...t.payload.updates}:e);return{...e,sites:s}}case"DELETE_SITE":{let s=e.sites.filter(e=>e.macAddress!==t.payload);return{...e,sites:s}}default:return e}}let h=(0,r.createContext)(void 0),p=new n(new i);function f(e){let{children:t}=e,[s,o]=(0,r.useReducer)(l,d),i=(e,t,s)=>{let a=e;if(t.trim()){let e=t.toLowerCase();a=a.filter(t=>t.siteCode.toLowerCase().includes(e)||t.siteName.toLowerCase().includes(e)||t.macAddress.toLowerCase().includes(e)||t.tags.some(t=>t.toLowerCase().includes(e)))}s.length>0&&(a=a.filter(e=>s.includes("无标签")?0===e.tags.length:s.some(t=>e.tags.includes(t)))),o({type:"UPDATE_FILTERED_SITES",payload:a})};(0,r.useEffect)(()=>{i(s.sites,s.searchTerm,s.selectedTags)},[s.sites,s.searchTerm,s.selectedTags]),(0,r.useEffect)(()=>{o({type:"SET_ALL_TAGS",payload:p.getAllTags()})},[s.sites]);let n={async loadSites(){o({type:"SET_LOADING",payload:!0}),o({type:"SET_ERROR",payload:null});try{let e=await p.loadData();o({type:"SET_SITES",payload:e}),o({type:"SET_LAST_SYNC_TIME",payload:p.getLastSyncTime()}),c.oR.success("成功加载 ".concat(e.length," 个站点"))}catch(t){let e=t instanceof Error?t.message:"加载站点失败";o({type:"SET_ERROR",payload:e}),c.oR.error(e)}finally{o({type:"SET_LOADING",payload:!1})}},async saveSites(){o({type:"SET_LOADING",payload:!0}),o({type:"SET_ERROR",payload:null});try{await p.saveData(),o({type:"SET_LAST_SYNC_TIME",payload:new Date}),c.oR.success("配置保存成功")}catch(t){let e=t instanceof Error?t.message:"保存配置失败";throw o({type:"SET_ERROR",payload:e}),c.oR.error(e),t}finally{o({type:"SET_LOADING",payload:!1})}},setEditMode(e){o({type:"SET_EDIT_MODE",payload:e})},setSearchTerm(e){o({type:"SET_SEARCH_TERM",payload:e})},setSelectedTags(e){o({type:"SET_SELECTED_TAGS",payload:e})},async addSite(e){try{p.addSite(e),o({type:"ADD_SITE",payload:e}),c.oR.success("站点 ".concat(e.siteCode," 添加成功"))}catch(t){let e=t instanceof Error?t.message:"添加站点失败";throw c.oR.error(e),t}},async updateSite(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{p.updateSite(e,t),o({type:"UPDATE_SITE",payload:{macAddress:e,updates:t}}),s||c.oR.success("站点更新成功")}catch(t){let e=t instanceof Error?t.message:"更新站点失败";throw c.oR.error(e),t}},async deleteSite(e){try{p.deleteSite(e),o({type:"DELETE_SITE",payload:e}),c.oR.success("站点删除成功")}catch(t){let e=t instanceof Error?t.message:"删除站点失败";throw c.oR.error(e),t}},async importSites(e){try{let t=p.importSites(e),s=p.getSites();return o({type:"SET_SITES",payload:s}),t.success>0&&c.oR.success("成功导入 ".concat(t.success," 个站点")),t.errors.length>0&&c.oR.error("导入失败: ".concat(t.errors.slice(0,3).join("; ")).concat(t.errors.length>3?"...":"")),t}catch(t){let e=t instanceof Error?t.message:"导入失败";throw c.oR.error(e),t}},async refreshData(){await n.loadSites()}};return(0,a.jsx)(h.Provider,{value:{state:s,actions:n},children:t})}function u(){let e=(0,r.useContext)(h);if(void 0===e)throw Error("useSiteContext must be used within a SiteProvider");return e}}}]);